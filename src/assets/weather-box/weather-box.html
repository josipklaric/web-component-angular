<template>
    <!-- <link rel="stylesheet" href="assets/weather-box/weather-box.css"> -->
    <style>
        :host {
            color: rgb(105, 105, 105);
        }

        i {
            color: #fff;
            font-family: weather;
            font-size: 1.5em;
            font-weight: normal;
            font-style: normal;
            text-transform: none;
        }
        
        h1 {
            margin: 0 0 8px;
            color: #fff;
            font-size: 100px;
            font-weight: 300;
            text-align: center;
            text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.15);
        }

        h2 {
            margin: 10px 0;
            color: #fff;
            font-size: 64px;
            font-weight: 100;
            text-align: center;
            text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.15);
        }

        h6 {
            margin: 2px;
            text-align: center;
            color: #fff;
        }

        ul {
            margin: 0;
            padding: 0 0 10px 0;
            text-align: center;
        }
        
        li {
            background: rgb(220, 220, 220);
            background: rgba(220, 220, 220, 0.9);
            padding: 10px;
            display: inline-block;
            border-radius: 5px;
        }
        
        .description {
            margin: 0 10px;
        }

        dl {
            width: 100%;
            overflow: hidden;
            padding: 0;
            margin: 0;
            text-align: center;
        }
        dt {
            padding: 5px;
            display: inline-block;
            color: #fff;
            font-size: 120px;
            text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.15);
            font-weight: lighter;
            vertical-align: top;
        }
        .unit {
            font-size: .5em;
            line-height: 1em;
        }

        .icon-0:before { content: ":"; }
        .icon-1:before { content: "p"; }
        .icon-2:before { content: "S"; }
        .icon-3:before { content: "Q"; }
        .icon-4:before { content: "S"; }
        .icon-5:before { content: "W"; }
        .icon-6:before { content: "W"; }
        .icon-7:before { content: "W"; }
        .icon-8:before { content: "W"; }
        .icon-9:before { content: "I"; }
        .icon-10:before { content: "W"; }
        .icon-11:before { content: "I"; }
        .icon-12:before { content: "I"; }
        .icon-13:before { content: "I"; }
        .icon-14:before { content: "I"; }
        .icon-15:before { content: "W"; }
        .icon-16:before { content: "I"; }
        .icon-17:before { content: "W"; }
        .icon-18:before { content: "U"; }
        .icon-19:before { content: "Z"; }
        .icon-20:before { content: "Z"; }
        .icon-21:before { content: "Z"; }
        .icon-22:before { content: "Z"; }
        .icon-23:before { content: "Z"; }
        .icon-24:before { content: "E"; }
        .icon-25:before { content: "E"; }
        .icon-26:before { content: "3"; }
        .icon-27:before { content: "a"; }
        .icon-28:before { content: "A"; }
        .icon-29:before { content: "a"; }
        .icon-30:before { content: "A"; }
        .icon-31:before { content: "6"; }
        .icon-32:before { content: "1"; }
        .icon-33:before { content: "6"; }
        .icon-34:before { content: "1"; }
        .icon-35:before { content: "W"; }
        .icon-36:before { content: "1"; }
        .icon-37:before { content: "S"; }
        .icon-38:before { content: "S"; }
        .icon-39:before { content: "S"; }
        .icon-40:before { content: "M"; }
        .icon-41:before { content: "W"; }
        .icon-42:before { content: "I"; }
        .icon-43:before { content: "W"; }
        .icon-44:before { content: "a"; }
        .icon-45:before { content: "S"; }
        .icon-46:before { content: "U"; }
        .icon-47:before { content: "S"; }

    </style>
    <div class="container">
        <h2 id="city">City</h2>
        <h6 id="location"></h6>
        <dl>
            <dt><i id="code"></i></dt>
            <dt><span id="temp"></span><span class="unit">C</span></dt>
        </dl>
        <ul>
            <li id="description" class="description">Clear</li>
            <li id="wind">0</li>
        </ul>
        <ul>
            <li id="copyright" style="padding:0;"><a href="https://www.yahoo.com/?ilc=401" target="_blank"> <img src="https://poweredby.yahoo.com/purple.png" width="134" height="29"/> </a></li>
            <li style="display:none;" ></li>
        </ul>
        <img style="display:none;" id="icon" src="https://s.yimg.com/zz/combo?a/i/us/nws/weather/gr/30d.png" />
    </div>
</template>

<script>
    
    const tpl = (document._currentScript || document.currentScript).ownerDocument.querySelector('template').content;
    const containerColor = 'blueviolet';

    class WeatherBox extends HTMLElement {

        constructor() {
            console.log('>> weather-box constructor entered.');
            super();
            //var shadowRoot = this.attachShadow({mode: 'open'});
            //shadowRoot.innerHTML = `<strong>Shadow dom super powers for the win!</strong>`;
        }

        static get observedAttributes() {
            return ['city', 'background'];
        }

        get city() {
            return this.getAttribute('city');
        }

        set city(cityName) {
            this.setAttribute('city', cityName);
        }

        get background() {
            return this.getAttribute('background');
        }

        set background(bgColor) {
            this.setAttribute('background', bgColor);
        }

        connectedCallback() {
            console.log('>> weather-box connected callback fired!');

            this.attachShadow({mode: 'open'});
            const content = document.importNode(tpl, true);
            this.shadowRoot.appendChild(content);

            this.render();
        }

        attributeChangedCallback(attr, oldValue, newValue) {
            console.log('>> weather-box attributeChanged callback fired!' + '\n\t> old value: ' + oldValue + ', new value: ' + newValue);

            if (attr == 'city') {
                if(oldValue) {
                    this.render();
                }
            }
            else if(attr == 'background') {
                console.log('>> weather-box attributeChanged -> background');
                if(oldValue && newValue != containerColor){
                    this.shadowRoot.querySelector('.container').style.background = newValue;
                }
            }
        }

        render() {
            
            this.shadowRoot.querySelector('#city').textContent = this.city;
            
            let query = `select * from weather.forecast where woeid in (select woeid from geo.places(1) where text='${this.city}') and u='c'`;
            let cacheFixer = Math.floor((new Date().getTime()) / 3600 / 1000);
            let yahooUrl = "https://query.yahooapis.com/v1/public/yql?q=" + encodeURIComponent(query) + "&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&_nocache=" + cacheFixer;
            console.log('>> web component > before fetch, yahooUrl: ' + yahooUrl);

            fetch(yahooUrl)
                .then((result) => { 
                    return result.json()
                })
                .then((result) => {
                    
                    console.log('>> web component > Fetch result: '+ result); //JSON.stringify(result));
                    if(!result.query.results)
                    {
                        console.log('>> web component > Fetch result: no results');
                        return;
                    }
                    this.shadowRoot.querySelector('.container').style.background = this.background;
                    this.shadowRoot.querySelector('#temp').textContent = `${result.query.results.channel.item.condition.temp}Â°`;
                    this.shadowRoot.querySelector('#code').className = `icon-${result.query.results.channel.item.condition.code}`;
                    this.shadowRoot.querySelector('#description').textContent = result.query.results.channel.item.condition.text;
                    this.shadowRoot.querySelector('#wind').textContent = `${result.query.results.channel.wind.speed} km/h`;
                    this.shadowRoot.querySelector('#icon').src = `https://s.yimg.com/zz/combo?a/i/us/nws/weather/gr/${result.query.results.channel.item.condition.code}n.png`;
                    //this.shadowRoot.querySelector('#icon').src = `assets/weather/250/${result.query.results.channel.item.condition.code}.png`;
                    this.shadowRoot.querySelector('#location').textContent = result.query.results.channel.description;

                    this.dispatchEvent(new CustomEvent('contentChanged', {
                        detail: {
                            temperature: result.query.results.channel.item.condition.temp,
                            description: result.query.results.channel.item.condition.text
                        }
                    }))
                })
                .catch(function(err) {  
                    console.log('>> web component > Fetch error: ', err);  
                })
        }
    }

    window.customElements.define('web component', WeatherBox);
</script>